---
description: KinOS Solar CRM project rules and context
globs:
alwaysApply: true
---

# KinOS â€” Solar CRM for KIN Home

## What This Project Is
KinOS is an internal CRM replacing Enerflo for KIN Home's solar sales operations.
Built with Next.js 16 (App Router), Supabase (Postgres + Auth + RLS), deployed on Vercel.
Epics 0â€“5 are complete. Epic 6 (Aurora Solar integration) is next.

## Critical Documentation
ALWAYS read these files before making architectural decisions:
- `/docs/PROJECT-KNOWLEDGE.md` â€” Master knowledge base (schema, data flows, APIs, decisions)
- `/docs/db-audit.md` â€” Live database inventory (47 tables + 2 views, verified 2026-02-11)
- `/docs/blueprint.md` â€” Full system architecture (reference, may lag behind actual state)

## Tech Stack
- **Framework:** Next.js 16 with App Router (NOT Pages Router). Middleware file is `proxy.ts` not `middleware.ts`.
- **Database:** Supabase (Postgres) with Row Level Security. 47 tables + 2 views live.
- **Auth:** Supabase Auth (email/password). No self-registration. Admin creates accounts.
- **Styling:** Tailwind CSS + shadcn/ui components
- **Language:** TypeScript (strict mode)
- **Package Manager:** pnpm
- **Deployment:** Vercel at kin-os-one.vercel.app (auto-deploys from main branch)

## Database Access Patterns
- **Browser/Client components:** Use `lib/supabase/client.ts` (anon key, respects RLS)
- **Server components/actions:** Use `lib/supabase/server.ts` (cookie-based auth, respects RLS)
- **Webhooks/API routes:** Use `lib/supabase/admin.ts` (service role, bypasses RLS)
- NEVER use the service role client in client components
- NEVER expose the service role key to the browser

## Pipeline Stages (19 stages â€” blueprint Â§9)
```
new_lead â†’ appointment_set â†’ appointment_sat â†’ design_requested â†’
design_complete â†’ proposal_sent â†’ proposal_accepted â†’ financing_applied â†’
financing_approved â†’ stips_pending â†’ stips_cleared â†’ contract_sent â†’
contract_signed â†’ submission_ready â†’ submitted â†’ intake_approved
                                                â†’ intake_rejected
Also: cancelled, lost
```
Stage constants are in `lib/constants/pipeline.ts`. Do NOT add, remove, or rename stages without explicit instruction.

Terminal stages: intake_approved, cancelled, lost
Revivable: lost â†’ appointment_set
Backward allowed: design_complete/proposal_sent â†’ design_requested (redesign)

KinOS pipeline ENDS at intake_approved. Everything after (install, permitting, inspection, PTO) lives in Quickbase.

## Key Tables (column counts from live DB)
- **deals** (78 cols) â€” core deal record with stage, pricing, system details, Aurora IDs
- **contacts** (44 cols) â€” customer info with utility/consumption fields, RepCard sync
- **proposals** (70 cols) â€” full pricing waterfall with design snapshot
- **users** (34 cols) â€” reps with RepCard sync, permission overrides
- **appointments** (24 cols) â€” RepCard appointment tracking with status/outcome
- **lender_products** (28 cols) â€” lender terms, rates, fee structure
- **v_deal_detail** (94 cols) â€” denormalized view joining deal + contact + users + office + team + lender
- **v_deal_pipeline** (20 cols) â€” compact view for kanban/list display

## Existing API Routes
- `/api/deals` â€” Deals CRUD + search
- `/api/deals/[id]/notes` â€” Deal notes
- `/api/deals/transition` â€” Stage transitions
- `/api/contacts` â€” Contacts CRUD
- `/api/contacts/[id]` â€” Contact detail + assign
- `/api/appointments` â€” Appointments CRUD + cancel
- `/api/attachments` â€” Attachments CRUD
- `/api/notes` â€” Notes CRUD
- `/api/filter-presets` â€” Filter presets CRUD
- `/api/webhooks/repcard/*` â€” 7 RepCard webhook routes (appointment-set, appointment-update, appointment-outcome, closer-update, status-changed, contact-type-changed, door-knocked)

## Existing Pages
- `/` â€” Dashboard
- `/deals` â€” Kanban + list pipeline views
- `/deals/[id]` â€” Deal detail with workflow stepper
- `/leads` â€” Lead management
- `/leads/[id]` â€” Lead detail
- `/calendar` â€” Calendar (day/week/month/list)
- `/reports` â€” Reports
- `/design-requests` â€” Design queue
- `/admin/*` â€” Admin panels
- `/login` â€” Auth

## Key Architecture Rules
- All data is company-isolated via RLS policies using `company_id`
- Soft deletes everywhere (`deleted_at` column, never hard delete)
- Major tables have `created_at`, `updated_at`, `updated_by`
- Deal stage transitions auto-logged by Postgres trigger to `deal_stage_history`
- Contact field changes auto-logged by Postgres trigger to `contact_change_history`
- Deal closer/setter changes auto-logged to `deal_assignment_history`
- Deal numbers auto-generate as `KIN-{YEAR}-{SEQ}` via Postgres trigger

## Code Conventions
- API routes go in `app/api/` â€” webhooks, CRUD endpoints
- Use server components by default, `"use client"` only when needed
- Error handling: always try/catch Supabase calls, return typed results
- No `any` types â€” use generated Supabase types from `lib/supabase/database.types.ts`
- Webhook handlers: always use `supabaseAdmin`, log to `webhook_events`, return 200 quickly

## Integrations Status
- **RepCard:** âœ… Complete â€” 7 webhook handlers, user sync, contact creation
- **Aurora Solar:** ðŸ”œ Epic 6 â€” API + webhooks for design workflow
- **Lender APIs:** ðŸ“‹ Planned (Epic 8)
- **PandaDoc/SignNow:** ðŸ“‹ Planned (Epic 9)
- **Quickbase:** ðŸ“‹ Planned (Epic 10)

## Aurora Solar Integration (Epic 6 context)
- Base URL: `https://api.aurorasolar.com`
- Auth: Bearer token + `X-Aurora-Api-Version: 2024.05`
- Tenant ID: `034b1c47-310a-460f-9d5d-b625dd354f12`
- Aurora webhooks are GET requests with data in URL query params (NOT POST with JSON)
- Key fields already on deals: aurora_project_id, aurora_design_id, system_size_kw, annual_production_kwh, offset_percentage, panel_count, panel_model, inverter_model
- Still needed: aurora_design_request_id (TEXT)

## Schema Drift Warning (Users table)
The live users table differs from blueprint. Missing fields that will be needed later:
kin_id, job_title, sequifi_id, captiveiq_id, quickbase_record_id, repcard_username
Do NOT add these unless explicitly asked â€” they're tracked for a future migration.

---

## POST-IMPLEMENTATION DOCUMENTATION REQUIREMENTS

After completing ANY task that changes the database schema, adds/removes API routes,
adds/removes tables, or changes the deal pipeline, you MUST update the relevant
documentation files before marking the task complete.

### When to update:

1. **New migration or schema change** â†’ Update `docs/PROJECT-KNOWLEDGE.md` section 3 (Database Schema)
   - Add new tables to the table summary
   - Add new migrations to the migration list
   - Note any new columns on existing tables
   - Update `docs/db-audit.md` with the table inventory

2. **New API route or webhook** â†’ Update `docs/PROJECT-KNOWLEDGE.md` section 4 (App Routes)
   - Add the route to the API Routes list
   - If it's a webhook, update section 5.2

3. **New page or UI route** â†’ Update `docs/PROJECT-KNOWLEDGE.md` section 4 (App Routes)

4. **Epic completed** â†’ Update `docs/PROJECT-KNOWLEDGE.md` section 9 (Epic Status)
   - Change status from ðŸ“‹ Planned â†’ âœ… Complete
   - Add summary notes

5. **Architecture decision** â†’ Update section 10 (Key Architecture Decisions)

6. **Pipeline stages changed** â†’ Update section 4 (Deal Lifecycle)

### Rules:
- Update the `Last updated` date at the top of PROJECT-KNOWLEDGE.md
- Keep entries concise â€” one line per table, one line per route
- Don't remove existing entries, only add or modify
- Commit doc updates in the SAME commit as the code changes
